//==========================================================
// Student Number : S10268773C
// Student Name : Luanne Lim Bai Yan
// Partner Name : Charmaine Yeo Wei en
//==========================================================
using S10268773C_PRG2Assignment;
using System.ComponentModel.Design;
using System.Diagnostics;
using System.Globalization;
using System.Net.Mail;
using System.Runtime.InteropServices.Marshalling;
List<Restaurant> restaurantList = new List<Restaurant>();
List<FoodItem> foodItemList = new List<FoodItem>();
List<Customer> customerList = new List<Customer>();
List<Order> orderList = new List<Order>();
List<OrderedFoodItem> orderfooditemList = new List<OrderedFoodItem>();
List<SpecialOffer> specialOfferList = new List<SpecialOffer>();
List<Order> RefundList = new List<Order>();
Dictionary<string, List<FoodItem>> restaurantAssignDict = new Dictionary<string, List<FoodItem>>();
Dictionary<string, Queue<Order>> restaurantOrderQueue = new Dictionary<string, Queue<Order>>();
Stack<Order> refundStack = new Stack<Order>();

//Part1 - Luanne
using (StreamReader sr = new StreamReader("restaurants.csv"))
{
    string? s = sr.ReadLine(); // header
    while ((s = sr.ReadLine()) != null)
    {
        string[] restaurantData = s.Split(",");
        string restaurantID = restaurantData[0].Trim();
        string restaurantName = restaurantData[1].Trim();
        string restaurantEmail = restaurantData[2].Trim();

        Restaurant restaurant = new Restaurant(restaurantID, restaurantName, restaurantEmail);
        restaurantList.Add(restaurant);
        restaurantOrderQueue[restaurantID] = new Queue<Order>();
        //Console.WriteLine("{0,-10}{1,-10}{2,-10}", restaurantID, restaurantName, restaurantEmail);
        // Prepare dictionary entry
        restaurantAssignDict[restaurantID] = new List<FoodItem>();
    }
}

using (StreamReader sr = new StreamReader("fooditems.csv"))
{
    string? s = sr.ReadLine();
    if (s != null)
    {
        string[] header = s.Split(',');
    }
    while ((s = sr.ReadLine()) != null)
    {
        string[] fooditemData = s.Split(",");
        string restaurantID = fooditemData[0].Trim();
        string fooditemName = fooditemData[1].Trim();
        string fooditemDesc = fooditemData[2].Trim();
        double fooditemPrice = Convert.ToDouble(fooditemData[3]);
        FoodItem fooditem = new FoodItem(fooditemName, fooditemDesc, fooditemPrice, " ");
        // must asign menu later now it is null so it doesnt need to be in the class for now
        foodItemList.Add(fooditem);
        if (restaurantAssignDict.ContainsKey(restaurantID))
        {
            restaurantAssignDict[restaurantID].Add(fooditem);
        }
    }
}

//Part2 - Charmaine
// Question2 (Load files for Customers and Objects) -Charmaine
// load the customers.csv file and create customeer objects based on the data loaded
using (StreamReader sr = new StreamReader("customers.csv"))
{
    string? s = sr.ReadLine(); // read the heading line
    if (s != null)
    {
        string[] heading = s.Split(','); // displayb the headings
        //Console.WriteLine("{0,-16},{1,-16}", heading[0], heading[1]);
    }
    while ((s = sr.ReadLine()) != null)
    {
        string[] customerData = s.Split(',');
        string emailAddress = customerData[1];
        string customerName = customerData[0];
        Customer customer = new Customer(emailAddress, customerName);
        customerList.Add(customer);

        //Console.WriteLine(customer); // test output
    }
}
// load the orders.csv file and create order objects based on the data loaded
using (StreamReader sr = new StreamReader("orders.csv"))
{
    string? s = sr.ReadLine(); // skip header
    while ((s = sr.ReadLine()) != null)
    {
        //Find where "Items" column starts
        int commaCount = 0;
        int itemsStartIndex = 0;

        for (int i = 0; i < s.Length; i++)
        {
            if (s[i] == ',') //couting the number of commas
            {
                commaCount++;
                if (commaCount == 9) // After 9 commas = Food/ ORDERED Items column
                {
                    itemsStartIndex = i + 1;
                    break;
                }
            }
        }

        // STEP 2: Split the line
        string firstPart = s.Substring(0, itemsStartIndex - 1); //everything before the fooditems
        string fooditemsPart = s.Substring(itemsStartIndex); // everything after my fooditems

        // STEP 3: Parse first part
        string[] firstColumns = firstPart.Split(','); //split the data BEFORE fooditems 

        // STEP 4: Remove quotes
        fooditemsPart = fooditemsPart.Trim('"'); //take away the " from the food items == e.g "Chicken Rice,1|Beef Burger,1|Caesar Salad,1"

        // Extract data
        int orderId = Convert.ToInt32(firstColumns[0]);
        string customerEmail = firstColumns[1].Trim();
        string restaurantId = firstColumns[2].Trim();
        DateTime deliveryDateTime = Convert.ToDateTime(firstColumns[3] + " " + firstColumns[4]);
        string deliveryAddress = firstColumns[5].Trim();
        DateTime orderDateTime = Convert.ToDateTime(firstColumns[6]);
        double totalAmount = Convert.ToDouble(firstColumns[7]);
        string status = firstColumns[8].Trim();

        // Find customer
        Customer foundCustomer = null;
        foreach (Customer c in customerList)
        {
            if (c.EmailAddress.Trim().ToLower() == customerEmail.ToLower())
            {
                foundCustomer = c;
                break;
            }
        }

        if (foundCustomer == null)
        {
            Console.WriteLine($"Customer {customerEmail} not found for order {orderId}.");
            continue;
        }

        // Find restuarant 
        Restaurant foundRestaurant = null;
        foreach (Restaurant r in restaurantList)
        {
            if (r.RestaurantId.Trim().ToLower() == restaurantId.ToLower())
            {
                foundRestaurant = r;
                break;
            }
        }

        if (foundRestaurant == null)
        {
            Console.WriteLine($"Restaurant {restaurantId} not found for order {orderId}.");
            continue;
        }

        // create order
        Order order = new Order(orderId, orderDateTime, totalAmount, status, deliveryDateTime, deliveryAddress, "Credit Card", true, foundCustomer, foundRestaurant);
        foundRestaurant.orderList.Add(order);
        if (status.ToLower() == "cancelled" || status.ToLower() == "delivered")
        {
            // Add to orderList for display in Option 2
            orderList.Add(order);
            // Add to customer's order history
            foundCustomer.orderList.Add(order);
            // DO NOT add to restaurantOrderQueue (no processing needed!)
        }
        else
        {
            // Add to orderList for display
            orderList.Add(order);
            // Add to customer's order history  
            foundCustomer.orderList.Add(order);
            // Add to restaurant queue for processing in Option 4
            restaurantOrderQueue[foundRestaurant.RestaurantId].Enqueue(order);
        }

        // add fooditems into orderList 
        if (fooditemsPart != "")
        {
            string[] items = fooditemsPart.Split('|');

            foreach (string item in items)
            {
                string[] parts = item.Split(',');

                if (parts.Length >= 2)
                {
                    string itemName = parts[0].Trim();
                    int qty = Convert.ToInt32(parts[1].Trim());

                    FoodItem foundFood = null;
                    foreach (FoodItem fi in foodItemList)
                    {
                        if (fi.ItemName.Trim().ToLower() == itemName.ToLower())
                        {
                            foundFood = fi;
                            break;
                        }
                    }

                    if (foundFood != null)
                    {
                        double subTotal = foundFood.ItemPrice * qty;
                        OrderedFoodItem orderedItem = new OrderedFoodItem(
                            foundFood.ItemName,
                            foundFood.ItemDesc,
                            foundFood.ItemPrice,
                            "",
                            qty,
                            subTotal,
                            order
                        );
                        order.AddOrderedFoodItem(orderedItem);
                    }
                }
            }
        }

        // Save order
        orderList.Add(order);
        foundCustomer.orderList.Add(order);
        restaurantOrderQueue[foundRestaurant.RestaurantId].Enqueue(order);

        if (status.ToLower() != "cancelled" && status.ToLower() != "delivered")
        {
            restaurantOrderQueue[foundRestaurant.RestaurantId].Enqueue(order);
        }
    }
}

//Creating new files
void SaveQueueToFile(Dictionary<string, Queue<Order>> restaurantOrderQueue)
{
    using (StreamWriter sw = new StreamWriter("queue.csv"))
    {
        // Write header
        sw.WriteLine("RestaurantID,OrderID,CustomerName,OrderStatus,OrderTotal,DeliveryDateTime");

        foreach (var kvp in restaurantOrderQueue)
        {
            string restaurantID = kvp.Key;
            Queue<Order> orderQueue = kvp.Value;

            foreach (Order order in orderQueue)
            {
                sw.WriteLine($"{restaurantID},{order.OrderId},{order.Ordercustomer.CustomerName}," +
                           $"{order.OrderStatus},{order.OrderTotal:F2},{order.DeliveryDateTime:yyyy-MM-dd HH:mm}");
            }
        }
    }
    Console.WriteLine("Queue data saved to queue.csv");
}

void SaveStackToFile(Stack<Order> refundStack)
{
    using (StreamWriter sw = new StreamWriter("stack.csv"))
    {
        // Write header
        sw.WriteLine("OrderID,CustomerName,OrderStatus,OrderTotal,DeliveryDateTime,RefundDateTime");

        // Since Stack is LIFO, we need to preserve order when writing
        List<Order> tempList = new List<Order>();

        // Copy stack to list to preserve order
        foreach (Order order in refundStack)
        {
            tempList.Add(order);
        }

        // Write in the order they would be processed (last in first out)
        for (int i = tempList.Count - 1; i >= 0; i--)
        {
            Order order = tempList[i];
            sw.WriteLine($"{order.OrderId},{order.Ordercustomer.CustomerName}," +
                       $"{order.OrderStatus},{order.OrderTotal:F2}," +
                       $"{order.DeliveryDateTime:yyyy-MM-dd HH:mm},{DateTime.Now:yyyy-MM-dd HH:mm}");
        }
    }
    Console.WriteLine("Stack data saved to stack.csv");
}

// Part3 (List all restaurants and menu items) - Charmaine
// Display all restaurants with their food items, name, descripton, price
void ListAllRestaurantsAndMenuItems(List<Restaurant> restaurantList)
    {
        Console.WriteLine();
        Console.WriteLine("All Restaurants and Menu Items");
        Console.WriteLine("==============================");
        foreach (Restaurant r in restaurantList)
        {
            Console.WriteLine("Restaurant: " + r.RestaurantName + " (" + r.RestaurantId + ")");
            if (restaurantAssignDict.ContainsKey(r.RestaurantId))
            {
                foreach (FoodItem f in restaurantAssignDict[r.RestaurantId])
                {
                    Console.WriteLine($" - {f.ItemName}: {f.ItemDesc} - ${f.ItemPrice:F2}");

                }
            }
            Console.WriteLine("\n");
        }
    }
//ListAllRestaurantsAndMenuItems(restaurantList);


//Part4 - Luanne Lim
void DisplayallOrders(List<Order> orderList)
{
    Console.WriteLine("All Orders");
    Console.WriteLine("==========");
    Console.WriteLine("{0,-8} {1,-15} {2,-15} {3,-20} {4,-10} {5,-15}",
        "OrderID", "Customer", "Restaurant", "Delivery Date/Time", "Amount", "Status");
    Console.WriteLine("-------- --------------- --------------- -------------------- ---------- ---------------");
    foreach (Order order in orderList)
    {
        string formattedDate = order.DeliveryDateTime.ToString("dd/MM/yyyy HH:mm");
        string formattedAmount = "$" + order.OrderTotal.ToString("F2");
        Console.WriteLine("{0,-8} {1,-15} {2,-15} {3,-20} {4,-10} {5,-15}",
            order.OrderId,
            order.Ordercustomer.CustomerName,
            order.Orderrestaurant.RestaurantName,
            formattedDate,
            formattedAmount,
            order.OrderStatus);
    }
    Console.WriteLine("\n");
}
//DisplayallOrders(orderList);


// Part5 (Create a new order) - Charmaine
void CreateNewOrder()
    {
        double deliveryFee = 5.00;

        Console.WriteLine();
        Console.WriteLine("Create New Order");
        Console.WriteLine("================");

        Console.Write("Enter Customer Email: ");
        string emailInput = Console.ReadLine();

        Customer customer1 = null;

        foreach (Customer c in customerList)
        {
            if (c.EmailAddress.Trim().ToLower() == emailInput.Trim().ToLower())
            {
                customer1 = c;
                break;
            }
        }

        if (customer1 == null)
        {
            Console.WriteLine("Invalid Customer Email.");
            return;
        }

        Console.Write("Enter Restaurant ID: ");
        string restaurantInput = Console.ReadLine();

        Restaurant restaurant1 = null;

        foreach (Restaurant r in restaurantList)
        {
            if (r.RestaurantId.Trim().ToLower() == restaurantInput.Trim().ToLower())
            {
                restaurant1 = r;
                break;
            }
        }

        if (restaurant1 == null)
        {
            Console.WriteLine("Invalid Restaurant ID.");
            return;
        }

        Console.Write("Enter Delivery Date (dd/mm/yyyy): ");
        string dateInput = Console.ReadLine();

        Console.Write("Enter Delivery Time (hh:mm): ");
        string timeInput = Console.ReadLine();

        Console.Write("Enter Delivery Address: ");
        string address = Console.ReadLine();

        DateTime deliveryDT = Convert.ToDateTime(dateInput + " " + timeInput);

        int newOrderId;

        if (orderList.Count > 0)
        {
            newOrderId = orderList[orderList.Count - 1].OrderId + 1;
        }
        else
        {
            newOrderId = 1001;
        }

        Order newOrder = new Order(newOrderId, DateTime.Now, 0.0, "Pending", deliveryDT, address, "", false, customer1, restaurant1);

        Console.WriteLine();
        Console.WriteLine("Available Food Items:");

        List<FoodItem> availableItems =
            restaurantAssignDict[restaurant1.RestaurantId];

        for (int i = 0; i < availableItems.Count; i++)
        {
            Console.WriteLine((i + 1) + ". " + availableItems[i].ItemName + " - $" + availableItems[i].ItemPrice);
        }

        double foodTotal = 0;

        while (true)
        {
            Console.Write("Enter item number (0 to finish): ");
            int choice = Convert.ToInt32(Console.ReadLine());

            if (choice == 0)
                break;

            if (choice < 1 || choice > availableItems.Count)
            {
                Console.WriteLine("Invalid item number.");
                continue;
            }

            Console.Write("Enter quantity: ");
            int quantity = Convert.ToInt32(Console.ReadLine());

            FoodItem selected = availableItems[choice - 1];

            double subTotal = selected.ItemPrice * quantity;
            foodTotal += subTotal;

            OrderedFoodItem ofi = new OrderedFoodItem(selected.ItemName, selected.ItemDesc, selected.ItemPrice, "", quantity, subTotal, newOrder);

            newOrder.AddOrderedFoodItem(ofi);
        }

        if (newOrder.orderfooditemList.Count > 0)
        {
            Console.Write("Add special request? [Y/N]: ");
            string special = Console.ReadLine();

            if (special.ToUpper() == "Y")
            {
                Console.Write("Enter special request: ");
                string request = Console.ReadLine();

                newOrder.orderfooditemList[0].Customise = request;
            }
        }

        newOrder.OrderTotal = foodTotal + deliveryFee;

        Console.WriteLine();
        Console.WriteLine("Order Total: $" + foodTotal + " + $5.00 (delivery) = $" + newOrder.OrderTotal);

        Console.Write("Proceed to payment? [Y/N]: ");
        string pay = Console.ReadLine();

        if (pay.ToUpper() == "Y")
        {
            Console.WriteLine("Payment method:");
            Console.Write("[CC] Credit Card / [PP] PayPal / [CD] Cash on Delivery: ");

            newOrder.OrderPaymentMethod = Console.ReadLine();
            newOrder.OrderPaid = true;

            // Save order
            orderList.Add(newOrder);
            customer1.AddOrder(newOrder);
            restaurant1.orderList.Add(newOrder);

            Console.WriteLine();
            Console.WriteLine("Order " + newOrder.OrderId + " created successfully!" + " Status: " + newOrder.OrderStatus);
        }
        else
        {
            Console.WriteLine("Payment cancelled.");
        }
        orderList.Add(newOrder);
        customer1.AddOrder(newOrder);
        restaurant1.orderList.Add(newOrder);
        restaurantOrderQueue[restaurant1.RestaurantId].Enqueue(newOrder);
        Console.WriteLine("\n");
    }
    //CreateNewOrder();

    //Part 6 - Luanne Lim
    void ProcessOrder(Dictionary<string, Queue<Order>> restaurantOrderQueue,
                      List<Order> orderList,
                      Stack<Order> refundStack,
                      List<OrderedFoodItem> orderedFoodList)
    {
        Console.WriteLine("Process Order");
        Console.WriteLine("===========");

        while (true)
        {
            Console.Write("Enter Restaurant ID (or X to exit): ");
            string inputRestaurantID = Console.ReadLine();

            if (inputRestaurantID.ToLower() == "x")
                break;

            // Check if restaurant exists
            if (!restaurantOrderQueue.ContainsKey(inputRestaurantID))
            {
                Console.WriteLine("Invalid Restaurant ID.\n");
                continue;
            }

            Queue<Order> orderQueue = restaurantOrderQueue[inputRestaurantID];

            if (orderQueue.Count == 0)
            {
                Console.WriteLine("No orders for this restaurant.\n");
                continue;
            }

            // Process orders one by one
            while (orderQueue.Count > 0)
            {
                Order detail = orderQueue.Peek(); // Just peek, don't dequeue yet!

                // Display order details - MATCH EXACT FORMAT
                Console.WriteLine($"\nOrder {detail.OrderId}:"); // <-- Colon after Order ID
                Console.WriteLine($"Customer: {detail.Ordercustomer.CustomerName}");
                Console.WriteLine("Ordered Items:");

                if (detail.orderfooditemList == null || detail.orderfooditemList.Count == 0)
                {
                    Console.WriteLine("No items in this order.");
                }
                else
                {
                    int itemNum = 1;
                    foreach (var item in detail.orderfooditemList)
                    {
                        Console.WriteLine($"{itemNum}. {item.ItemName} - {item.QtyOrdered}"); // <-- Exact format
                        itemNum++;
                    }
                }

                // Display order total and status - MATCH EXACT FORMAT
                Console.WriteLine($"Delivery date/time: {detail.DeliveryDateTime:dd/MM/yyyy HH:mm}"); // <-- lowercase "date/time"
                Console.WriteLine($"Total Amount: ${detail.CalculateOrderTotal():F2}");
                Console.WriteLine($"Order Status: {detail.OrderStatus}\n");

                // Show options - FIXED: Added [O] option
                Console.Write("[C]onfirm / [R]eject / [S]kip / [D]eliver: ");
                string choice = Console.ReadLine().ToLower();

            // Remove current order first
            orderQueue.Dequeue();

            if (choice == "c") // Confirm
            {
                if (detail.OrderStatus == "Pending")
                {
                    detail.OrderStatus = "Confirmed";
                    Console.WriteLine($"Order {detail.OrderId} confirmed. Status: {detail.OrderStatus}");
                }
                else if (detail.OrderStatus == "Confirmed")
                {
                    detail.OrderStatus = "Preparing";
                    Console.WriteLine($"Order {detail.OrderId} preparing. Status:  {detail.OrderStatus}");
                }
                else if (detail.OrderStatus == "Preparing")
                {
                    detail.OrderStatus = "Out for Delivery";
                    Console.WriteLine($"Order {detail.OrderId} out for delivery. Status: {detail.OrderStatus}");
                }
                else
                {
                    Console.WriteLine("Cannot confirm at this stage.");
                    Console.WriteLine($"Order {detail.OrderId} Status: {detail.OrderStatus}");
                }
                orderQueue.Enqueue(detail);
            }

            else if (choice == "d") // Deliver
            {
                if (detail.OrderStatus == "Out for Delivery")
                {
                    detail.OrderStatus = "Delivered";
                    Console.WriteLine($"Order {detail.OrderId} delivered. Status {detail.OrderStatus}");
                }
                else
                {
                    Console.WriteLine("Order is not ready for delivery.");
                    orderQueue.Enqueue(detail);
                }
            }

            else if (choice == "r") // Reject
            {
                if (detail.OrderStatus == "Pending")
                {
                    detail.OrderStatus = "Cancelled";
                    refundStack.Push(detail);

                    Console.WriteLine($"Order {detail.OrderId} cancelled.Status {detail.OrderStatus}");
                }
                else
                {
                    Console.WriteLine("Only pending orders can be rejected.");
                    orderQueue.Enqueue(detail);
                }
            }

            else if (choice == "s") // Skip
            {
                Console.WriteLine($"Order {detail.OrderId} skipped.Status {detail.OrderStatus}");
                orderQueue.Enqueue(detail);
            }

            else
            {
                Console.WriteLine("Invalid choice.");
                orderQueue.Enqueue(detail);
            }

            if (detail.OrderStatus != "Delivered" && detail.OrderStatus != "Cancelled")
            {
                orderQueue.Enqueue(detail);
            }
            else
            {
                orderQueue.Dequeue();
            }

                Console.WriteLine("\n"); // Add spacing for readability
            }
        }
    }
//ProcessOrder(restaurantOrderQueue, orderList, refundStack, orderfooditemList);

// Question7 (Modify an existing order) -Charmaine
void ModifyOrder(List<Customer> customerList, Dictionary<string, List<FoodItem>> restaurantAssignDict)
{
    Console.WriteLine();
    Console.WriteLine("Modify Order");
    Console.WriteLine("=============");

    // prompt user to enter customer email
    string emailAddress = "";
    Customer selectedCustomer = null;

    while (selectedCustomer == null)
    {
        Console.Write("Enter Customer Email: ");
        emailAddress = Console.ReadLine();

        if (emailAddress == null || emailAddress == "")
        {
            Console.WriteLine("Customer Email cannot be empty.");
            continue;
        }
        else if (!emailAddress.Contains("@") || !emailAddress.Contains("."))
        {
            Console.WriteLine("Invalid email format. Example: alice.tan@email.com");
            continue;
        }


        // search for customer
        selectedCustomer = null;
        foreach (Customer c in customerList)
        {
            if (c.EmailAddress.Trim().ToLower() == emailAddress.Trim().ToLower())
            {
                selectedCustomer = c;
                break;
            }
        }

        if (selectedCustomer == null)
        {
            Console.WriteLine("Customer not found.");
        }
    }

    // display all orders from order list that are "Pending"
    List<Order> pendingOrders = new List<Order>();
    foreach (Order order in selectedCustomer.orderList)
    {
        if (order.OrderStatus.Trim().ToLower() == "pending")
        {
            pendingOrders.Add(order);
        }
    }

    if (pendingOrders.Count == 0)
    {
        Console.WriteLine("No pending orders for this customer.");
        return;
    }

    Console.WriteLine("Pending Orders:");
    foreach (Order o in pendingOrders)
    {
        Console.WriteLine(o.OrderId);
    }

    // prompt user to enter order id 
    Console.Write("Enter Order ID: ");
    //int OrderIdinput = Convert.ToInt32(Console.ReadLine()!);
    int OrderIdinput = -1;
    while (OrderIdinput == -1)
    {
        string input = Console.ReadLine();

        try
        {
            OrderIdinput = Convert.ToInt32(input);
        }
        catch
        {
            Console.WriteLine("Order ID must be a number.");
            OrderIdinput = -1;
        }
    }

    // find order to modify
    Order? orderToModify = null;
    foreach (Order pendingOrder in pendingOrders)
    {
        if (pendingOrder.OrderId == OrderIdinput)
        {
            orderToModify = pendingOrder;
            break;
        }
    }
    if (orderToModify == null)
    {
        Console.WriteLine("Order not found.");
        return;
    }
    // display items ordered, delivery address and delivery time
    Console.WriteLine("Order Items:");
    int itemIndex = 1;
    foreach (OrderedFoodItem item in orderToModify.orderfooditemList)
    {
        Console.WriteLine($"{itemIndex}. {item.ItemName} - {item.QtyOrdered}");
        itemIndex++;
    }

    if (itemIndex == 1)
    {
        Console.WriteLine("No items found in this order.");
    }

    Console.WriteLine("Address:");
    Console.WriteLine(orderToModify.DeliveryAddress);
    Console.WriteLine("Delivery Date/Time:");
    Console.WriteLine($"{orderToModify.DeliveryDateTime:d/M/yyyy, HH:mm}");

    // prompt user to select a modification
    Console.WriteLine();
    Console.Write("Modify: [1] Items [2] Address [3] Delivery Time: ");
    //int modifyChoice = Convert.ToInt32(Console.ReadLine());
    int modifyChoice = -1;
    while (modifyChoice < 1 || modifyChoice > 3)
    {
        try
        {
            modifyChoice = Convert.ToInt32(Console.ReadLine());
            if (modifyChoice < 1 || modifyChoice > 3)
            {
                Console.WriteLine("Invalid option. Choose 1, 2, or 3.");
            }
        }
        catch
        {
            Console.WriteLine("Invalid input.");
        }
    }

    // accept updated data and apply changes (including data of order total)
    if (modifyChoice == 1)
    {
        List<FoodItem> availableFoodItems = restaurantAssignDict[orderToModify.Orderrestaurant.RestaurantId];
        Console.WriteLine("Available Food Items:");
        for (int i = 0; i < availableFoodItems.Count; i++)
        {
            Console.WriteLine($"{i + 1}. {availableFoodItems[i].ItemName} - ${availableFoodItems[i].ItemPrice:F2}");
        }

        double oldTotal = orderToModify.OrderTotal;
        double deliveryFee = 5.0;

        while (true)
        {
            Console.Write("Enter item number (0 to finish): ");
            int choice = Convert.ToInt32(Console.ReadLine());
            if (choice == 0) break;
            if (choice < 1 || choice > availableFoodItems.Count)
            {
                Console.WriteLine("Invalid item number.");
                continue;
            }

            Console.Write("Enter quantity: ");
            int qty = Convert.ToInt32(Console.ReadLine());
            FoodItem selectedItem = availableFoodItems[choice - 1];

            // check if item already exists, add quantity if yes
            bool exists = false;
            foreach (OrderedFoodItem ofi in orderToModify.orderfooditemList)
            {
                if (ofi.ItemName == selectedItem.ItemName)
                {
                    ofi.QtyOrdered = ofi.QtyOrdered + qty;
                    ofi.SubTotal = ofi.QtyOrdered * ofi.ItemPrice;
                    exists = true;
                    break;
                }
            }
            if (!exists)
            {
                OrderedFoodItem newItem = new OrderedFoodItem(
                    selectedItem.ItemName,
                    selectedItem.ItemDesc,
                    selectedItem.ItemPrice,
                    "",
                    qty,
                    selectedItem.ItemPrice * qty,
                    orderToModify
                );
                orderToModify.AddOrderedFoodItem(newItem);
            }
        }
        // recalculate order total after modification
        double foodTotal = 0;
        foreach (OrderedFoodItem ofi in orderToModify.orderfooditemList)
        {
            foodTotal += ofi.SubTotal;
        }
        orderToModify.OrderTotal = foodTotal + deliveryFee;

        if (orderToModify.OrderTotal > oldTotal)
        {
            Console.WriteLine($"Order total increased from ${oldTotal:F2} to ${orderToModify.OrderTotal:F2}.");
            Console.Write("Proceed to payment? [Y/N]: ");
            string payInput = Console.ReadLine();
            if (payInput.ToUpper() == "Y")
            {
                Console.WriteLine("Payment method:");
                Console.Write("[CC] Credit Card / [PP] PayPal / [CD] Cash on Delivery: ");
                orderToModify.OrderPaymentMethod = Console.ReadLine();
                orderToModify.OrderPaid = true;
            }
        }

        Console.WriteLine($"Order {orderToModify.OrderId} updated. New Total: ${orderToModify.OrderTotal:F2}");
    }

    // modify address
    else if (modifyChoice == 2)
    {
        string newAddress = "";
        while (newAddress == "")
        {
            Console.Write("Enter new Delivery Address: ");
            newAddress = Console.ReadLine();

            if (newAddress == null || newAddress == "")
            {
                Console.WriteLine("Delivery Address cannot be empty.");
                newAddress = "";
            }
            else if (newAddress[0] == ' ' || !newAddress.Contains("#") || !newAddress.Contains(" "))
            {
                Console.WriteLine("Invalid address format. Example: 123 Orchard Road #05-01");
                newAddress = "";
            }
        }
        orderToModify.DeliveryAddress = newAddress;
        Console.WriteLine("Updated Delivery Address: " + orderToModify.DeliveryAddress);
    }
    // modify delivery time
    else if (modifyChoice == 3)
    {
        DateTime newDeliveryDT = DateTime.Now; // temporary
        string dateInput = "";
        string timeInput = "";
        int day = 0;
        int month = 0;
        int year = 0;
        int hour = 0;
        int minute = 0;

        while (true)
        {
            Console.Write("Enter new Delivery Date (dd/mm/yyyy): ");
            dateInput = Console.ReadLine();

            Console.Write("Enter new Delivery Time (hh:mm): ");
            timeInput = Console.ReadLine();

            // basic check for format using length and separator
            if (dateInput.Length != 10 || timeInput.Length != 5 || dateInput[2] != '/' || dateInput[5] != '/' || timeInput[2] != ':')
            {
                Console.WriteLine("Invalid format. Date should be dd/mm/yyyy and time hh:mm.");
                continue;
            }

            // split manually
            string dayStr = "" + dateInput[0] + dateInput[1];
            string monthStr = "" + dateInput[3] + dateInput[4];
            string yearStr = "" + dateInput[6] + dateInput[7] + dateInput[8] + dateInput[9];
            string hourStr = "" + timeInput[0] + timeInput[1];
            string minuteStr = "" + timeInput[3] + timeInput[4];

            // convert manually
            day = Convert.ToInt32(dayStr);
            month = Convert.ToInt32(monthStr);
            year = Convert.ToInt32(yearStr);
            hour = Convert.ToInt32(hourStr);
            minute = Convert.ToInt32(minuteStr);

            // simple validation
            if (day < 1 || day > 31 || month < 1 || month > 12 || hour < 0 || hour > 23 || minute < 0 || minute > 59)
            {
                Console.WriteLine("Invalid date or time values. Example: 01/02/2026 12:30");
                continue;
            }

            break; // valid input
        }

        // assign to order
        orderToModify.DeliveryDateTime = new DateTime(year, month, day, hour, minute, 0);
        Console.WriteLine("Updated Delivery Date/Time: " + orderToModify.DeliveryDateTime.ToString("dd/MM/yyyy HH:mm"));
    }
    // message if nothing was modified
    else
    {
        Console.WriteLine("No modifications made.");
        return;
    }
    Console.WriteLine("\n");
}



//Part 8 - Luanne Lim
void DeleteExistingOrder(List<Order> orderList, List<OrderedFoodItem> orderedFoodList)
    {
        Console.WriteLine("Delete Order");
        Console.WriteLine("============");

        Console.Write("Enter Customer Email:");
        string usercustomerEmail = Console.ReadLine().Trim().ToLower();

        Console.WriteLine("Pending Orders:");

        foreach (Order item in orderList)
        {
            if (item.OrderStatus.ToLower() == "pending" && item.Ordercustomer.EmailAddress.ToLower() == usercustomerEmail)
            {
                Console.WriteLine(item.OrderId);
            }
        }
        Console.Write("Enter Order ID: ");
        int userOrderID = Convert.ToInt32(Console.ReadLine());
        Console.WriteLine("\n");

        Order selectedOrder = null;

        foreach (Order item in orderList)
        {
            if (item.OrderId == userOrderID &&
                item.OrderStatus.ToLower() == "pending")
            {
                selectedOrder = item;
                break;
            }
        }

        if (selectedOrder == null)
        {
            Console.WriteLine("Order not found.");
            return;
        }
        Console.WriteLine("Customer: {0}", selectedOrder.Ordercustomer.CustomerName);
        Console.WriteLine("Ordered Items:");
        int itemnum = 1;

        foreach (OrderedFoodItem detail in orderfooditemList)
        {
            if (detail.OrderOFI.OrderId == selectedOrder.OrderId)
            {
                Console.WriteLine("{0}. {1} - {2}",
                    itemnum, detail.ItemName, detail.QtyOrdered);
                itemnum++;
            }
        }

        Console.WriteLine("Delivery date/time: {0}", selectedOrder.DeliveryDateTime);
        Console.WriteLine("Total Amount: ${0}", selectedOrder.CalculateOrderTotal());
        Console.WriteLine("Order Status: {0}", selectedOrder.OrderStatus);

        Console.Write("Confirm deletion? [Y/N]: ");
        string userAnswer = Console.ReadLine().ToLower();

        if (userAnswer == "y")
        {
            selectedOrder.OrderStatus = "Cancelled";
            Console.WriteLine("Order {0} cancelled.", selectedOrder.OrderId);
        }
        else if (userAnswer == "n")
        {
            Console.WriteLine("Order not cancelled.");
        }
        else
        {
            Console.WriteLine("Invalid answer.");
        }
        Console.WriteLine("\n");
    Console.WriteLine("\n");
    }
    //DeleteExistingOrder(orderList, orderfooditemList);

    //Advanced features
    //(a)
    void BulkProcessing(List<Order> orderList)
    {
        int totalOrders = orderList.Count;
        int pendingCount = 0;
        int processedCount = 0;
        int preparingCount = 0;
        int rejectedCount = 0;

        // Count pending orders
        foreach (Order order in orderList)
        {
            if (order.OrderStatus.ToLower() == "pending")
            {
                pendingCount++;
            }
        }

        Console.WriteLine("Number of Orders Processed: {0}", pendingCount);

        // Process pending orders
        foreach (Order order in orderList)
        {
            if (order.OrderStatus.ToLower() == "pending")
            {
                double diff = (order.DeliveryDateTime - order.OrderDateTime).TotalMinutes;

                if (diff < 60)
                {
                    order.OrderStatus = "Rejected";
                    rejectedCount++;
                }
                else
                {
                    order.OrderStatus = "Preparing";
                    preparingCount++;
                }

                processedCount++;
            }
        }

        // Calculate percentage
        double percentage = 0;

        if (totalOrders > 0)
        {
            percentage = (double)processedCount / totalOrders * 100;
            //"(double)" converts the value into a double
        }

        // Display summary
        Console.WriteLine("\n=== Bulk Processing of Unprocessed Orders ===");
        Console.WriteLine("=============================================");
        Console.WriteLine("Preparing Orders: {0}", preparingCount);
        Console.WriteLine("Rejected Orders: {0}", rejectedCount);
        Console.WriteLine("Percentage Processed: {0:F2}%", percentage);
        Console.WriteLine("\n");
    }
    //BulkProcessing(orderList);

    //Bonus Feature -- Create a special order with a special offer  
    //Special Offer =   orders that are placed between 12 to 2pm have a 20% discount in their total amount
    void ApplySpecialOffers()
    {
        foreach (Order order in orderList)
        {
            int hour = order.OrderDateTime.Hour;

            // Only between 12pm and 2pm
            if (hour >= 12 && hour <= 14 && order.HasDiscount == false)
            {
                foreach (SpecialOffer offer in specialOfferList)
                {
                    // Check if this offer belongs to this restaurant
                    if (order.Orderrestaurant == offer.SOrestaurant)
                    {
                        // Apply discount from SpecialOffer class
                        double discountRate = offer.Discount;

                        order.OrderTotal *= (1 - discountRate);
                        order.HasDiscount = true;

                        Console.WriteLine($"Offer {offer.OfferCode} applied to Order {order.OrderId}");
                    }
                }
            }
        }
    }

void DisplayTotalOrderAmount(List<Restaurant> restaurantList, List<Order> allOrders)
{
    double grandRefund = 0;
    double gruberooTotal = 0;

    Console.WriteLine("Total Order Amount Per Restaurant");
    Console.WriteLine("================================\n");

    foreach (Restaurant restaurant in restaurantList)
    {
        double restaurantTotal = 0; // 70% to restaurant
        double restaurantRefund = 0;

        // Get all orders for this restaurant using a regular loop
        List<Order> restaurantOrders = new List<Order>();
        foreach (Order order in allOrders)
        {
            if (order.Orderrestaurant.RestaurantId == restaurant.RestaurantId)
            {
                restaurantOrders.Add(order);
            }
        }

        foreach (Order order in restaurantOrders)
        {
            if (order.OrderStatus.ToLower() == "delivered")
            {
                double orderAmount = order.OrderTotal - 5; // subtract delivery fee
                double restaurantShare = orderAmount * 0.7;
                double gruberooShare = orderAmount * 0.3;

                restaurantTotal += restaurantShare;
                gruberooTotal += gruberooShare;
            }
            else if (order.OrderStatus.ToLower() == "cancelled") // Changed from "refunded" to "cancelled"
            {
                restaurantRefund += order.OrderTotal;
            }
        }

        Console.WriteLine($"Restaurant: {restaurant.RestaurantName}");
        Console.WriteLine($"Total order amount (to restaurant): ${restaurantTotal:F2}");
        Console.WriteLine($"Total refunds: ${restaurantRefund:F2}\n");

        grandRefund += restaurantRefund;
    }

    Console.WriteLine("Total Order Amount Summary");
    Console.WriteLine("==========================");
    Console.WriteLine($"Total Overall Refunds: ${grandRefund:F2}");
    Console.WriteLine($"Final Amount Gruberoo earns: ${gruberooTotal:F2}");
    Console.WriteLine();
}

void mainprogram()
{
    //Start of Program
    Console.WriteLine("Welcome to the Gruberoo Food Delivery System \r\n");
    Console.WriteLine("{0} restuarants loaded!", restaurantList.Count);
    Console.WriteLine("{0} food items loaded!", foodItemList.Count);
    Console.WriteLine("{0} customers loaded!", customerList.Count);
    Console.WriteLine("{0} orders loaded!", orderList.Count);
    Console.WriteLine("\n");
    //Main Program
     while (true)
     {
        Console.WriteLine("===== Gruberoo Food Delivery System ===== ");
        Console.WriteLine("1. List all restaurants and menu items");
        Console.WriteLine("2. List all orders ");
        Console.WriteLine("3. Create a new order ");
        Console.WriteLine("4. Process an order ");
        Console.WriteLine("5. Modify an existing order");
        Console.WriteLine("6. Delete an existing order");
        Console.WriteLine("7. Bulk Processing of Unprocessed Orders");
        Console.WriteLine("8. Display Total Order Amount Per Restaurant");
        Console.WriteLine("0. Exit");
        Console.Write("Enter your choice: ");
        int userAnswer = Convert.ToInt32(Console.ReadLine());

        if (userAnswer == 0)
        {
            //When exit is chosen, the information in the queue and stack are saved to new files queue.csv and stack.csv respectively. 
            // Save data to files before exiting
            Console.WriteLine("\nSaving data...");
            SaveQueueToFile(restaurantOrderQueue);
            SaveStackToFile(refundStack);
            Console.WriteLine("Thank you for using Gruberoo Food Delivery System!");
            break;
        }
        else if (userAnswer == 1)
        {
            ListAllRestaurantsAndMenuItems(restaurantList);
        }
        else if (userAnswer == 2)
        {
            DisplayallOrders(orderList);
        }
        else if (userAnswer == 3)
        {
            CreateNewOrder();
        }
        else if (userAnswer == 4)
        {
            ProcessOrder(restaurantOrderQueue, orderList, refundStack, orderfooditemList);
        }
        else if (userAnswer == 5)
        {
            ModifyOrder(customerList, restaurantAssignDict);
        }
        else if (userAnswer == 6)
        {
            DeleteExistingOrder(orderList, orderfooditemList);
        }
        else if (userAnswer == 7)
        {
            BulkProcessing(orderList);
        }
        else if (userAnswer == 8)
        {
            DisplayTotalOrderAmount(restaurantList, orderList);
        }
     }
}
mainprogram();
